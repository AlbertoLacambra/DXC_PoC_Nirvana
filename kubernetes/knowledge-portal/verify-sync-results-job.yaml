apiVersion: batch/v1
kind: Job
metadata:
  name: verify-sync-results
  namespace: cloudmind
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: psql
        image: postgres:15
        command:
        - /bin/bash
        - -c
        - |
          set -e
          
          echo "ðŸ“Š Verificando resultados de la sincronizaciÃ³n..."
          echo ""
          
          psql -h "$POSTGRES_HOST" -U "$POSTGRES_USER" -d "$POSTGRES_DB" <<EOF
          
          -- Contar documentos procesados
          SELECT 
            'ðŸ“„ Documentos sincronizados:' as metric,
            COUNT(*) as count
          FROM source_documents
          WHERE sync_status = 'synced';
          
          -- Contar chunks generados
          SELECT 
            'ðŸ“¦ Chunks generados:' as metric,
            COUNT(*) as count
          FROM knowledge_chunks;
          
          -- Contar embeddings
          SELECT 
            'ðŸ”® Embeddings generados:' as metric,
            COUNT(*) as count
          FROM knowledge_chunks
          WHERE embedding IS NOT NULL;
          
          -- Ver distribuciÃ³n por categorÃ­a
          SELECT 
            'ðŸ“ Por tipo de archivo' as info,
            SUBSTRING(file_path FROM '\.([^.]+)$') as extension,
            COUNT(*) as count
          FROM source_documents
          GROUP BY extension
          ORDER BY count DESC
          LIMIT 10;
          
          -- Ãšltimos documentos sincronizados
          SELECT 
            'â° Ãšltimos 5 documentos' as info,
            file_path,
            chunks_count,
            last_synced
          FROM source_documents
          ORDER BY last_synced DESC NULLS LAST
          LIMIT 5;
          
          EOF
          
          echo ""
          echo "âœ… VerificaciÃ³n completada"
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-credentials
              key: password
        - name: POSTGRES_HOST
          valueFrom:
            secretKeyRef:
              name: postgres-credentials
              key: host
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: postgres-credentials
              key: username
        - name: POSTGRES_DB
          value: "nirvana_knowledge"
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
