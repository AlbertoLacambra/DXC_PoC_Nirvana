apiVersion: batch/v1
kind: Job
metadata:
  name: fix-file-type-column
  namespace: cloudmind
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: psql
        image: postgres:15
        command:
        - /bin/bash
        - -c
        - |
          set -e
          
          echo "ðŸ”§ Fixing file_type column constraint..."
          
          psql -h "$POSTGRES_HOST" -U "$POSTGRES_USER" -d "$POSTGRES_DB" <<EOF
          -- Make file_type nullable
          ALTER TABLE source_documents 
          ALTER COLUMN file_type DROP NOT NULL;
          
          -- Verify change
          \d source_documents
          EOF
          
          echo "âœ… Column fixed successfully"
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-credentials
              key: password
        - name: POSTGRES_HOST
          valueFrom:
            secretKeyRef:
              name: postgres-credentials
              key: host
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: postgres-credentials
              key: username
        - name: POSTGRES_DB
          value: "nirvana_knowledge"
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
